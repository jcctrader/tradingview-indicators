//@version=5
indicator("Macro Risk Regime Map", overlay=false)

// ==============================
// Inputs
// ==============================

// Growth proxy (can be replaced with custom macro series)
growthSource = input.source(close, "Growth Proxy Source")

trendLen     = input.int(63, "Trend Lookback", minval=10)
slowdownLvl  = input.float(-50.0, "Slowdown Threshold (%)")

// ==============================
// Growth Impulse Calculation
// ==============================

// Rate of change
roc = ta.roc(growthSource, trendLen)

// Normalize to +/- 100
highestROC = ta.highest(math.abs(roc), trendLen)
growthImpulse = highestROC != 0 ? (roc / highestROC) * 100 : 0

// ==============================
// Trend Reset Logic
// ==============================

// Trend direction
trendDir = growthImpulse > 0 ? 1 : -1

// Detect direction change (trend reset)
trendReset = ta.change(trendDir)

// Force reset values
growthAdj =
     trendReset
     ? (trendDir > 0 ? 100 : -100)
     : growthImpulse

// ==============================
// Regime State Machine
// ==============================

var int regime = 0
//  1 = Risk-On
//  0 = Slowdown
// -1 = Risk-Off

if trendReset
    regime := growthAdj > 0 ? 1 : -1
else
    if regime == -1
        regime := growthAdj > 0 ? 1 : growthAdj > slowdownLvl ? 0 : -1
    else if regime == 0
        regime := growthAdj > 0 ? 1 : growthAdj <= slowdownLvl ? -1 : 0
    else
        regime := growthAdj <= 0 ? -1 : 1

// ==============================
// Visualization
// ==============================

// Colors
riskOnColor   = color.new(color.green, 0)
slowColor     = color.new(color.yellow, 0)
riskOffColor  = color.new(color.red, 0)

// Plot impulse
plot(growthAdj, title="Growth Impulse", color=regime == 1 ? riskOnColor : regime == 0 ? slowColor : riskOffColor, linewidth=2)

// Threshold lines
hline(0, "Zero Line", color=color.gray, linestyle=hline.style_dashed)
hline(slowdownLvl, "Slowdown Threshold", color=color.red, linestyle=hline.style_dotted)
hline(100, "", display=display.none)
hline(-100, "", display=display.none)

// Background shading
bgcolor(regime == 1 ? color.new(color.green, 85) : regime == 0 ? color.new(color.yellow, 85) : color.new(color.red, 85))

